FROM alpine:3.12

# Install packages
RUN apk --update --no-cache add \
  coreutils dumb-init findutils logrotate \
  munin nginx perl-cgi-fast procps \
  rrdtool-cached spawn-fcgi sudo openssl \
  ttf-opensans tzdata ssmtp mailx patch \
 && sed '/^[^*].*$/d; s/ munin //g' /etc/munin/munin.cron.sample | crontab -u munin -  \
 && sed -i 's#^log_file.*#log_file /dev/stdout#' /etc/munin/munin-node.conf \
 && sed -i 's|^root|#root|' /etc/ssmtp/ssmtp.conf \
 && ln -s /usr/sbin/ssmtp /usr/lib/sendmail \
# && ln -s /usr/sbin/ssmtp /usr/sbin/sendmail \
 && sed -i -r -e 's|formatted_value = sprintf "%.2f",|formatted_value = sprintf "%.4f",|' /usr/share/perl5/vendor_perl/Munin/Master/LimitsOld.pm \
 && cd /usr/lib/munin/plugins \
 && printf '\
LS0tIHBvc3RmaXhfbWFpbHN0YXRzCisrKyBwb3N0Zml4X21haWxzdGF0cwpAQCAtMTk1LDYgKzE5NSw3IEBAIHN1YiBwYXJzZUxvZ2ZpbGUKICAgICAgICAg\
fQogICAgICAgICBlbHNpZiAoJGxpbmUgPX4gL3Bvc3RmaXhcL3NtdHBkLipwcm94eS1yZWplY3Q6IFxTKyAoXFMrKS8gfHwKICAgICAgICAgICAgICAgICRs\
aW5lID1+IC9wb3N0Zml4XC9zbXRwZC4qcmVqZWN0OiBcUysgXFMrIFxTKyAoXFMrKS8gfHwKKyAgICAgICAgICAgICAgICRsaW5lID1+IC9wb3N0Zml4XC9w\
b3N0c2NyZWVuLipyZWplY3Q6IFxTKyBcUysgXFMrIChcUyspLyB8fAogICAgICAgICAgICAgICAgJGxpbmUgPX4gL3Bvc3RmaXhcL2NsZWFudXAuKiByZWpl\
Y3Q6IChcUyspLyB8fAogICAgICAgICAgICAgICAgJGxpbmUgPX4gL3Bvc3RmaXhcL2NsZWFudXAuKiBtaWx0ZXItcmVqZWN0OiBcUysgXFMrIFxTKyAoXFMr\
KS8pCiAgICAgICAgIHsKLS0tIC9kZXYvbnVsbAorKysgc3NsX2V4cGlyZV8KQEAgLTAsMCArMSw2MCBAQAorIyEvYmluL2Jhc2gKKyMgLSotIHNoIC0qLQor\
Cis6IDw8ID1jdXQKKworPWhlYWQxIE5BTUUKKworc3NsX2V4cGlyZV8gLSBXaWxkY2FyZC1wbHVnaW4gdG8gbW9uaXRvciBzc2wgY2VydGlmaWNhdGUgZXhw\
aXJhdGlvbgorCis9aGVhZDEgQ09ORklHVVJBVElPTgorCitUaGlzIHBsdWdpbiBkb2VzIG5vdCBub3JtYWxseSByZXF1aXJlIGNvbmZpZ3VyYXRpb24uCisK\
K1RvIHNldCB3YXJuaW5nIGFuZCBjcml0aWNhbCBsZXZlbHMgZG8gbGlrZSB0aGlzOgorCisgIFtzc2xfZXhwaXJlXypdCisgICAgZW52Lndhcm5pbmcgNjA6\
CisgICAgZW52LmNyaXRpY2FsIDE1OgorCis9aGVhZDEgQVVUSE9SCisKK0NvcHlyaWdodCAoQykgMjAxMyBQYXRyaWNrIERvbWFjayA8cGF0cmlja2RrQHBh\
dHJpY2tkay5jb20+CisKKz1oZWFkMSBMSUNFTlNFCisKK0dQTHYyCisKKz1oZWFkMSBNQUdJQyBNQVJLRVJTCisKKyAjJSMgZmFtaWx5PWF1dG8KKyAjJSMg\
Y2FwYWJpbGl0aWVzPWF1dG9jb25mIHN1Z2dlc3QKKworPWN1dAorCisuICRNVU5JTl9MSUJESVIvcGx1Z2lucy9wbHVnaW4uc2gKKworU0lURT0kezAjIypz\
c2xfZXhwaXJlX30KKworY2FzZSAkMSBpbgorICAgIGNvbmZpZykKKworICAgICAgICBlY2hvICJncmFwaF90aXRsZSAkU0lURSBTU0wgQ2VydGlmaWNhdGUg\
RXhwaXJlIgorICAgICAgICBlY2hvICdncmFwaF9hcmdzIC0tYmFzZSAxMDAwJworICAgICAgICBlY2hvICdncmFwaF92bGFiZWwgZGF5cyBsZWZ0JworICAg\
ICAgICBlY2hvICdncmFwaF9jYXRlZ29yeSBzc2wnCisgICAgICAgIGVjaG8gImdyYXBoX2luZm8gVGhpcyBncmFwaCBzaG93cyB0aGUgZGF5cyBsZWZ0IGZv\
ciB0aGUgY2VydGlmaWNhdGUgYmVpbmcgc2VydmVkIGJ5ICRTSVRFIgorICAgICAgICBlY2hvICdleHBpcmUubGFiZWwgZGF5cycKKyAgICAgICAgcHJpbnRf\
d2FybmluZyBleHBpcmUKKyAgICAgICAgcHJpbnRfY3JpdGljYWwgZXhwaXJlCisKKyAgICAgICAgZXhpdCAwCisgICAgICAgIDs7Citlc2FjCisKK2NlcnQ9\
JChlY2hvICIiIHwgb3BlbnNzbCBzX2NsaWVudCAtQ0FwYXRoIC9ldGMvc3NsL2NlcnRzIC1zZXJ2ZXJuYW1lICIke1NJVEV9IiAtY29ubmVjdCAiJHtTSVRF\
fTo0NDMiIDI+L2Rldi9udWxsKTsKKworaWYgW1sgIiR7Y2VydH0iID0gKiItLS0tLUJFR0lOIENFUlRJRklDQVRFLS0tLS0iKiBdXTsgdGhlbgorICBlY2hv\
ICIke2NlcnR9IiB8IG9wZW5zc2wgeDUwOSAtbm9vdXQgLWVuZGRhdGUgfCBhd2sgLUY9ICdCRUdJTiB7IHNwbGl0KCJKYW4gRmViIE1hciBBcHIgTWF5IEp1\
biBKdWwgQXVnIFNlcCBPY3QgTm92IERlYyIsIG1vbnRoLCAiICIpOyBmb3IgKGk9MTsgaTw9MTI7IGkrKykgbWRpZ2l0W21vbnRoW2ldXSA9IGk7IH0gL25v\
dEFmdGVyLyB7IHNwbGl0KCQwLGEsIj0iKTsgc3BsaXQoYVsyXSxiLCIgIik7IHNwbGl0KGJbM10sdGltZSwiOiIpOyBkYXRldGltZT1iWzRdICIgIiBtZGln\
aXRbYlsxXV0gIiAiIGJbMl0gIiAiIHRpbWVbMV0gIiAiIHRpbWVbMl0gIiAiIHRpbWVbM107IGRheXM9KG1rdGltZShkYXRldGltZSktc3lzdGltZSgpKS84\
NjQwMDsgcHJpbnQgImV4cGlyZS52YWx1ZSAiIGRheXM7IH0nCitmaQorCi0tLSBteXNxbF8KKysrIG15c3FsXwpAQCAtMTE5MSw3ICsxMTkxLDcgQEAgc3Vi\
IHVwZGF0ZV9pbm5vZGIgewogICAgIG15ICRyb3cgPSAkc3RoLT5mZXRjaHJvd19oYXNocmVmKCk7CiAgICAgbXkgJHN0YXR1cyA9ICRyb3ctPnsnc3RhdHVz\
J307CiAgICAgJHN0aC0+ZmluaXNoKCk7Ci0KKyAgICAkc3RhdHVzID1+IHMvLS0tLS0tLS0tLS0tLS0tLS1cbk1haW4gdGhyZWFkLy9nOyAjQWRkZWQgZml4\
IGZvciBwZXJjb25hPwogICAgIHBhcnNlX2lubm9kYl9zdGF0dXMoJHN0YXR1cyk7CiB9CiAKLS0tIHNubXBfX2lmXworKysgc25tcF9faWZfCkBAIC0xNzks\
NiArMTc5LDcgQEAgaWYgKCRBUkdWWzBdIGFuZCAkQVJHVlswXSBlcSAiY29uZmlnIikgewogICAgIH0KIAogICAgIG15ICR3YXJuID0gdW5kZWY7CisgICAg\
bXkgJGNyaXQgPSB1bmRlZjsKICAgICBteSAkc3BlZWQgPSB1bmRlZjsKIAogICAgIGlmIChkZWZpbmVkICgkc3BlZWQgPSAkc2Vzc2lvbi0+Z2V0X3Npbmds\
ZSgkaWZFbnRyeVNwZWVkKSkpIHsKQEAgLTE5Nyw3ICsxOTgsOCBAQCBpZiAoJEFSR1ZbMF0gYW5kICRBUkdWWzBdIGVxICJjb25maWciKSB7CiAJCQkqIDEw\
MDAgKiAxMDAwOwogCX0KIAotCSR3YXJuID0gKCRzcGVlZC8xMCkqODsKKwkkd2FybiA9ICgkc3BlZWQvMTApKjY7CisJJGNyaXQgPSAoJHNwZWVkLzEwKSo4\
OwogCiAJIyBXYXJuIGF0IDEvOHRoIG9mIGFjdHVhbGwgc3BlZWQ/ICBPciBqdXN0IHJlbW92ZSB3YXJuaW5nPwogCSMgVGVtcHRlZCB0byBzZXQgd2Fybmlu\
ZyBhdCA4MCUuIDgwJSBvdmVyIDUgbWludXRlcyBpcyBwcmV0dHkKQEAgLTIzOCwxNCArMjQwLDE0IEBAIGlmICgkQVJHVlswXSBhbmQgJEFSR1ZbMF0gZXEg\
ImNvbmZpZyIpIHsKICAgICBwcmludCAicmVjdi5jZGVmIHJlY3YsOCwqXG4iOwogICAgIHByaW50ICJyZWN2Lm1heCAkc3BlZWRcbiIgaWYgJHNwZWVkOwog\
ICAgIHByaW50ICJyZWN2Lm1pbiAwXG4iOwotICAgIHByaW50ICJyZWN2Lndhcm5pbmcgIiwgKCR3YXJuKSwgIlxuIiBpZiBkZWZpbmVkICR3YXJuICYmICgk\
d2FybiAhPSAwKTsKKyAgICBwcmludF90aHJlc2hvbGRzKCJyZWN2Iix1bmRlZix1bmRlZiwkd2FybiwkY3JpdCkgaWYgZGVmaW5lZCAkd2FybiAmJiBkZWZp\
bmVkICRjcml0OwogICAgIHByaW50ICJzZW5kLmxhYmVsIGJwc1xuIjsKICAgICBwcmludCAic2VuZC50eXBlIERFUklWRVxuIjsKICAgICBwcmludCAic2Vu\
ZC5uZWdhdGl2ZSByZWN2XG4iOwogICAgIHByaW50ICJzZW5kLmNkZWYgc2VuZCw4LCpcbiI7CiAgICAgcHJpbnQgInNlbmQubWF4ICRzcGVlZFxuIiBpZiAk\
c3BlZWQ7CiAgICAgcHJpbnQgInNlbmQubWluIDBcbiI7Ci0gICAgcHJpbnQgInNlbmQud2FybmluZyAkd2FyblxuIiBpZiBkZWZpbmVkICR3YXJuICYmICgk\
d2FybiAhPSAwKTsKKyAgICBwcmludF90aHJlc2hvbGRzKCJzZW5kIix1bmRlZix1bmRlZiwkd2FybiwkY3JpdCkgaWYgZGVmaW5lZCAkd2FybiAmJiBkZWZp\
bmVkICRjcml0OwogICAgIGV4aXQgMDsKIH0KIAotLS0gc25tcF9faWZfZXJyXworKysgc25tcF9faWZfZXJyXwpAQCAtMTMxLDYgKzEzMSw3IEBAIGlmICgk\
QVJHVlswXSBhbmQgJEFSR1ZbMF0gZXEgImNvbmZpZyIpIHsKIAogICAgICMgQW55IGVycm9yIGlzIHRvbyBtYW55CiAgICAgbXkgJHdhcm4gPSAxOworICAg\
IG15ICRjcml0ID0gMTAwOwogCiAgICAgcHJpbnQgImdyYXBoX3RpdGxlIEludGVyZmFjZSAkYWxpYXMgZXJyb3JzXG4iOwogICAgIHByaW50ICJncmFwaF9v\
cmRlciByZWN2IHNlbmRcbiI7CkBAIC0xNDMsMTIgKzE0NCwxMiBAQCBpZiAoJEFSR1ZbMF0gYW5kICRBUkdWWzBdIGVxICJjb25maWciKSB7CiAgICAgcHJp\
bnQgInJlY3YudHlwZSBERVJJVkVcbiI7CiAgICAgcHJpbnQgInJlY3YuZ3JhcGggbm9cbiI7CiAgICAgcHJpbnQgInJlY3YubWluIDBcbiI7Ci0gICAgcHJp\
bnQgInJlY3Yud2FybmluZyAiLCAoJHdhcm4pLCAiXG4iIGlmIGRlZmluZWQgJHdhcm47CisgICAgcHJpbnRfdGhyZXNob2xkcygicmVjdiIsdW5kZWYsdW5k\
ZWYsJHdhcm4sJGNyaXQpIGlmIGRlZmluZWQgJHdhcm4gJiYgZGVmaW5lZCAkY3JpdDsKICAgICBwcmludCAic2VuZC5sYWJlbCBlcnJvcnNcbiI7CiAgICAg\
cHJpbnQgInNlbmQudHlwZSBERVJJVkVcbiI7CiAgICAgcHJpbnQgInNlbmQubmVnYXRpdmUgcmVjdlxuIjsKICAgICBwcmludCAic2VuZC5taW4gMFxuIjsK\
LSAgICBwcmludCAic2VuZC53YXJuaW5nICR3YXJuXG4iIGlmIGRlZmluZWQgJHdhcm47CisgICAgcHJpbnRfdGhyZXNob2xkcygic2VuZCIsdW5kZWYsdW5k\
ZWYsJHdhcm4sJGNyaXQpIGlmIGRlZmluZWQgJHdhcm4gJiYgZGVmaW5lZCAkY3JpdDsKICAgICBleGl0IDA7CiB9CiAKLS0tIHNubXBfX2lmX211bHRpCisr\
KyBzbm1wX19pZl9tdWx0aQpAQCAtNjEzLDEyICs2MTMsMTQgQEAgc3ViIGRvX2NvbmZpZ19pZiB7CiAgICAgfQogCiAgICAgbXkgJHdhcm4gPSB1bmRlZjsK\
KyAgICBteSAkY3JpdCA9IHVuZGVmOwogICAgIG15ICRzcGVlZCA9IDA7CiAKICAgICBpZiAoZGVmaW5lZCAoJHNwZWVkID0gJHNubXBpbmZvWC0+eyRpZn0t\
PntpZkhpZ2hTcGVlZH0pIGFuZCAkc3BlZWQpIHsKICAgICAgICMgU3BlZWQgaW4gMSwwMDAsMDAwIGJpdHMgcGVyIHNlY29uZAogICAgICAgJHNwZWVkID0g\
JHNwZWVkICogMTAwMDAwMDsKLSAgICAgICR3YXJuID0gJHNwZWVkICogNzUgLyAxMDA7CisgICAgICAkd2FybiA9ICRzcGVlZCAqIDYwIC8gMTAwOworICAg\
ICAgJGNyaXQgPSAkc3BlZWQgKiA4MCAvIDEwMDsKIAogICAgICAgbXkgJHRleHRzcGVlZCA9IHNjYWxlTnVtYmVyKCRzcGVlZCwnYnBzJywnJywKIAkJCQkg\
ICdUaGUgaW50ZXJmYWNlIHNwZWVkIGlzICUuMWYlcyVzLicpOwpAQCAtNjI2LDcgKzYyOCw4IEBAIHN1YiBkb19jb25maWdfaWYgewogICAgICAgJGV4dHJh\
aW5mbyAuPSAnICcuJHRleHRzcGVlZCBpZiAkdGV4dHNwZWVkOwogICAgIH0gZWxzaWYgKGRlZmluZWQgKCRzcGVlZCA9ICRzbm1waW5mby0+eyRpZn0tPntp\
ZlNwZWVkfSkgYW5kICRzcGVlZCkgewogICAgICAgICAjIFNwZWVkIGluIGJpdHMgcHIuIHNlY29uZAotCSR3YXJuID0gJHNwZWVkLzEwMCo3NTsKKwkkd2Fy\
biA9ICRzcGVlZC8xMDAqNjA7CisJJGNyaXQgPSAkc3BlZWQvMTAwKjgwOwogCiAJbXkgJHRleHRzcGVlZCA9IHNjYWxlTnVtYmVyKCRzcGVlZCwnYnBzJywn\
JywKIAkJCQkgICAgJ1RoZSBpbnRlcmZhY2Ugc3BlZWQgaXMgJS4xZiVzJXMuJyk7CkBAIC02NjYsMTcgKzY2OSwyMCBAQCBzdWIgZG9fY29uZmlnX2lmIHsK\
ICAgICBwcmludCAicmVjdi5jZGVmIHJlY3YsOCwqXG4iOwogICAgIHByaW50ICJyZWN2Lm1heCAkc3BlZWRcbiIgaWYgJHNwZWVkOwogICAgIHByaW50ICJy\
ZWN2Lm1pbiAwXG4iOwotICAgIHByaW50ICJyZWN2Lndhcm5pbmcgJHdhcm5cbiIgaWYgZGVmaW5lZCAkd2FybjsKKyAgICBwcmludF90aHJlc2hvbGRzKCJy\
ZWN2Iix1bmRlZix1bmRlZiwkd2FybiwkY3JpdCkgaWYgZGVmaW5lZCAkd2FybiAmJiBkZWZpbmVkICRjcml0OwogICAgIHByaW50ICJzZW5kLmxhYmVsIGJw\
c1xuIjsKICAgICBwcmludCAic2VuZC50eXBlIERFUklWRVxuIjsKICAgICBwcmludCAic2VuZC5uZWdhdGl2ZSByZWN2XG4iOwogICAgIHByaW50ICJzZW5k\
LmNkZWYgc2VuZCw4LCpcbiI7CiAgICAgcHJpbnQgInNlbmQubWF4ICRzcGVlZFxuIiBpZiAkc3BlZWQ7CiAgICAgcHJpbnQgInNlbmQubWluIDBcbiI7Ci0g\
ICAgcHJpbnQgInNlbmQud2FybmluZyAkd2FyblxuIiBpZiBkZWZpbmVkICR3YXJuOworICAgIHByaW50X3RocmVzaG9sZHMoInNlbmQiLHVuZGVmLHVuZGVm\
LCR3YXJuLCRjcml0KSBpZiBkZWZpbmVkICR3YXJuICYmIGRlZmluZWQgJGNyaXQ7CiAKICAgICBwcmludCAibXVsdGlncmFwaCBpZl9lcnJvcnMuaWZfJGlm\
XG4iOwogCisgICAgJHdhcm49MTsKKyAgICAkY3JpdD0xMDA7CisKICAgICBwcmludCAiZ3JhcGhfdGl0bGUgSW50ZXJmYWNlICRhbGlhcyBlcnJvcnNcbiI7\
CiAgICAgcHJpbnQgImdyYXBoX29yZGVyIHJlY3Ygc2VuZFxuIjsKICAgICBwcmludCAiZ3JhcGhfYXJncyAtLWJhc2UgMTAwMFxuIjsKQEAgLTY4OSwxMiAr\
Njk1LDEyIEBAIHN1YiBkb19jb25maWdfaWYgewogICAgIHByaW50ICJyZWN2LnR5cGUgREVSSVZFXG4iOwogICAgIHByaW50ICJyZWN2LmdyYXBoIG5vXG4i\
OwogICAgIHByaW50ICJyZWN2Lm1pbiAwXG4iOwotICAgIHByaW50ICJyZWN2Lndhcm5pbmcgMVxuIjsKKyAgICBwcmludF90aHJlc2hvbGRzKCJyZWN2Iix1\
bmRlZix1bmRlZiwkd2FybiwkY3JpdCkgaWYgZGVmaW5lZCAkd2FybiAmJiBkZWZpbmVkICRjcml0OwogICAgIHByaW50ICJzZW5kLmxhYmVsIGVycm9yc1xu\
IjsKICAgICBwcmludCAic2VuZC50eXBlIERFUklWRVxuIjsKICAgICBwcmludCAic2VuZC5uZWdhdGl2ZSByZWN2XG4iOwogICAgIHByaW50ICJzZW5kLm1p\
biAwXG4iOwotICAgIHByaW50ICJzZW5kLndhcm5pbmcgMVxuIjsKKyAgICBwcmludF90aHJlc2hvbGRzKCJzZW5kIix1bmRlZix1bmRlZiwkd2FybiwkY3Jp\
dCkgaWYgZGVmaW5lZCAkd2FybiAmJiBkZWZpbmVkICRjcml0OwogfQogCiAK\
' | base64 -d | patch -p0 \
 && chmod a+x * \
 && chmod a-x plugins* \
 && mkdir /run/nginx

COPY rootfs/ /

# Expose volumes
#VOLUME /etc/munin/munin-conf.d /etc/munin/plugin-conf.d /var/lib/munin /var/log/munin

# Expose nginx
EXPOSE 80

# Use dumb-init since we run a lot of processes
ENTRYPOINT ["/usr/bin/dumb-init", "--"]

# Run start script or what you choose
CMD /docker-cmd.sh
